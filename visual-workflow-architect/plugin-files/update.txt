function(instance, properties, context) {
    console.log('=== UPDATE: Visual Workflow Architect Starting ===');
    console.log('UPDATE: Instance data from Bubble:', instance.data);
    
    // Find the container by looking for our plugin container
    var containerElement = instance.canvas.find('.workflow-architect-container[data-plugin-id]');
    
    if (containerElement.length === 0) {
        console.log('UPDATE: No initialized container found, plugin may not be initialized');
        instance.canvas.html('<div style="padding:20px; color: red;">Plugin container not found. Initialize function may have failed.</div>');
        return;
    }
    
    // Get data from DOM attributes
    var pluginId = containerElement.attr('data-plugin-id');
    var isInitialized = containerElement.attr('data-initialized') === 'true';
    
    console.log('UPDATE: Found container with plugin ID:', pluginId);
    console.log('UPDATE: Container initialized:', isInitialized);
    
    if (!isInitialized) {
        console.log('UPDATE: Container not properly initialized');
        containerElement.html('<div style="padding:20px; color: red;">Container not properly initialized</div>');
        return;
    }
    
    // Check if required scripts are loaded
    console.log('UPDATE: Checking for WorkflowArchitectDataStore...');
    if (typeof window.WorkflowArchitectDataStore === 'undefined') {
        console.log('UPDATE: Data store script not loaded');
        containerElement.html('<div style="padding:20px; border: 2px solid #ff4444; border-radius: 8px; background: #fff5f5; color: #cc0000;">Data Store script not loaded<br>Check plugin headers for data-store.js</div>');
        return;
    }
    
    // Initialize Event Bridge immediately (critical for storymap-grid pattern)
    console.log('UPDATE: Checking for WorkflowArchitectEventBridge...', typeof window.WorkflowArchitectEventBridge);
    if (window.WorkflowArchitectEventBridge) {
        console.log('UPDATE: WorkflowArchitectEventBridge found, initializing...');
        window.WorkflowArchitectEventBridge.init(instance);
        console.log('UPDATE: WorkflowArchitectEventBridge initialized');
    }
    
    // Initialize sequence event bridge if available
    if (window.SequenceDiagramEventBridge) {
        console.log('UPDATE: SequenceDiagramEventBridge found, initializing...');
        window.SequenceDiagramEventBridge.init(instance);
        console.log('UPDATE: SequenceDiagramEventBridge initialized');
    }
    
    // Show success if all scripts loaded but no feature selected
    if (!properties.feature) {
        console.log('UPDATE: No feature selected');
        containerElement.html('<div style="padding:20px; background: #e8f5e8; border: 2px solid #4caf50; border-radius: 8px; color: #2e7d32;"><h3>Visual Workflow Architect Ready</h3><p>All scripts loaded successfully!</p><p><strong>Next step:</strong> Select a feature in the element properties</p><p>Plugin ID: ' + pluginId + '</p></div>');
        return;
    }
    
    try {
        console.log('UPDATE: Processing feature data...');
        
        // Extract feature data
        var featureId = properties.feature.get('_id');
        var featureName = properties.feature.get('name_text') || properties.feature.get('name') || 'Untitled Feature';
        
        var containerCount = properties.containers ? properties.containers.length() : 0;
        var sequenceCount = properties.sequences ? properties.sequences.length() : 0;
        
        console.log('UPDATE: Feature:', featureName, 'Containers:', containerCount, 'Sequences:', sequenceCount);
        
        var allContainers = containerCount > 0 ? properties.containers.get(0, containerCount) : [];
        var allSequences = sequenceCount > 0 ? properties.sequences.get(0, sequenceCount) : [];
        
        // Process containers
        var containers = [];
        for (var i = 0; i < allContainers.length; i++) {
            var container = allContainers[i];
            containers.push({
                container_id: container.get('_id'),
                name_text: container.get('name_text') || container.get('name') || 'Container ' + (i + 1),
                type_text: container.get('Persona') ? 'Persona' : 'Component',
                color_hex_text: container.get('color_hex') || '#3ea50b',
                order_index_number: container.get('order_index') || i,
                feature_id: featureId
            });
        }
        
        // Process sequences
        var sequences = [];
        for (var j = 0; j < allSequences.length; j++) {
            var sequence = allSequences[j];
            sequences.push({
                sequence_id: sequence.get('_id'),
                label_text: sequence.get('Label') || sequence.get('label_text') || 'Sequence ' + (j + 1),
                from_container_id: sequence.get('FromContainer') ? sequence.get('FromContainer').get('_id') : null,
                to_container_id: sequence.get('ToContainer') ? sequence.get('ToContainer').get('_id') : null,
                is_dashed_boolean: sequence.get('is_dashed') || false,
                color_hex_text: sequence.get('color_hex') || '#1976d2',
                order_index_number: sequence.get('order_index') || j,
                feature_id: featureId
            });
        }
        
        console.log('UPDATE: Processed', containers.length, 'containers and', sequences.length, 'sequences');
        
        // Initialize data store
        var bubbleData = {
            feature: {
                feature_id: featureId,
                name_text: featureName
            },
            containers: containers,
            sequences: sequences
        };
        
        // Initialize data stores
        window.WorkflowArchitectDataStore.init(bubbleData);
        
        if (window.SequenceDiagramDataStore) {
            if (!window.SequenceDiagramDataStore.isInitialized) {
                console.log('UPDATE: Initializing sequence data store for the first time...');
                window.SequenceDiagramDataStore.init(bubbleData.feature, containers, sequences);
            } else {
                console.log('UPDATE: Refreshing data store with current Bubble data');
                window.SequenceDiagramDataStore.loadData(bubbleData.feature, containers, sequences);
            }
        }
        
        // Store feature ID in DOM for persistence
        containerElement.attr('data-feature-id', featureId);
        
        // Check if already rendered to prevent infinite loop
        if (containerElement.attr('data-diagram-rendered') === 'true') {
            console.log('UPDATE: Diagram already rendered, skipping to prevent infinite loop');
            return;
        }
        
        // Initialize view manager if available
        if (window.WorkflowArchitectViewManager) {
            console.log('UPDATE: Initializing view manager...');
            var fullContainerId = 'workflow-architect-' + pluginId;
            window.WorkflowArchitectViewManager.init(fullContainerId, bubbleData);
        }
        
        // Initialize renderer if available
        if (window.WorkflowArchitectRenderer) {
            console.log('UPDATE: Initializing renderer...');
            window.WorkflowArchitectRenderer.init(pluginId);
            
            // Mark as rendered BEFORE calling render to prevent loops
            containerElement.attr('data-diagram-rendered', 'true');
            
            // Call renderer with data and target element
            console.log('UPDATE: Calling renderer...');
            window.WorkflowArchitectRenderer.render(bubbleData, containerElement);
            console.log('UPDATE: Renderer completed successfully');
        } else {
            // Fallback display if renderer not available
            containerElement.html('<div style="padding:20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;"><h3>Feature: ' + featureName + '</h3><p>Containers: ' + containers.length + '</p><p>Sequences: ' + sequences.length + '</p><p>Renderer not available - check headers.txt</p></div>');
        }
        
        console.log('=== UPDATE: Completed successfully ===');

    } catch (err) {
        console.error('UPDATE: Error occurred:', err);
        
        if (err.message === 'not ready') {
            console.log('UPDATE: Bubble not ready, showing loading message');
            containerElement.html('<div style="padding:20px; text-align:center; color: #666;">Loading Visual Workflow Architect...</div>');
            throw err;
        }
        
        containerElement.html('<div style="padding:20px; border: 2px solid #ff4444; border-radius: 8px; background: #fff5f5; color: #cc0000;">ERROR<br>' + err.message + '<br><small>Check console for details</small></div>');
    }
}
